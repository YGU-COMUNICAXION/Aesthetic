---
import { Image } from "astro:assets";

interface Props {
  title: string;
  subtitle: string;
  images?: any[];
  videoId?: string;
}

const { title, subtitle, images = [], videoId } = Astro.props;
---

<figure class="overflow-hidden">
  {
    videoId ? (
      <div class="aspect-video w-full rounded-3xl overflow-hidden mb-4">
        <iframe
          src={`https://www.youtube.com/embed/${videoId}`}
          title={title}
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
          class="w-full h-full"
        />
      </div>
    ) : images.length === 1 ? (
      <Image
        src={images[0]}
        alt={`${title} — ${subtitle} — Imagen 1`}
        class="w-full aspect-square object-cover rounded-3xl mb-4 transition-all duration-700"
      />
    ) : (
      images.length > 1 && (
        <gallery-slider images={JSON.stringify(images)} class="w-full block" />
      )
    )
  }
  <figcaption class="text-center">
    <p class="font-light text-lg lg:text-xl">
      {title}
      <span class="mx-1">-</span>
      {subtitle}
    </p>
  </figcaption>
</figure>

<script>
  class GallerySlider extends HTMLElement {
    [x: string]: any;
    connectedCallback() {
      this.images = JSON.parse(this.getAttribute("images") || "[]");
      this.idx = 0;
      this.nextIdx = 1 % this.images.length;
      this.showing = 0; // 0 o 1, cuál imagen está visible
      this.render();
      this.timer = setInterval(() => this.next(), 3500);
    }
    disconnectedCallback() {
      clearInterval(this.timer);
    }
    next() {
      const imgs = this.querySelectorAll("img");
      if (imgs.length < 2) return;
      imgs[this.showing].classList.remove("opacity-100");
      imgs[this.showing].classList.add("opacity-0");
      imgs[1 - this.showing].src =
        this.images[(this.idx + 1) % this.images.length].src;
      imgs[1 - this.showing].alt =
        this.images[(this.idx + 1) % this.images.length].alt || "";
      setTimeout(() => {
        imgs[1 - this.showing].classList.remove("opacity-0");
        imgs[1 - this.showing].classList.add("opacity-100");
        this.idx = (this.idx + 1) % this.images.length;
        this.showing = 1 - this.showing;
      }, 50);
    }
    render() {
      this.innerHTML = "";
      if (!this.images.length) return;
      // Dos imágenes superpuestas para el fade
      const imgA = document.createElement("img");
      imgA.src = this.images[0].src;
      imgA.alt = this.images[0].alt || "";
      imgA.className =
        "absolute top-0 left-0 w-full aspect-square object-cover rounded-3xl mb-4 transition-opacity duration-700 opacity-100";
      const imgB = document.createElement("img");
      imgB.src = this.images[1 % this.images.length].src;
      imgB.alt = this.images[1 % this.images.length].alt || "";
      imgB.className =
        "absolute top-0 left-0 w-full aspect-square object-cover rounded-3xl mb-4 transition-opacity duration-700 opacity-0";
      const wrapper = document.createElement("div");
      wrapper.className = "relative w-full aspect-square";
      wrapper.appendChild(imgA);
      wrapper.appendChild(imgB);
      this.appendChild(wrapper);
    }
  }
  if (!customElements.get("gallery-slider")) {
    customElements.define("gallery-slider", GallerySlider);
  }
</script>
